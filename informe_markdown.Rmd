---
title: "Proyecto: An√°lisis de sensibilidad de del precio de productos agr√≠colas a factores externos"
output:
  html_document:
    df_print: paged
    theme: journal
    toc: true
    toc_float: true
    number_sections: true
    code_folding: show
lang: "es-ES"
---

# Introducci√≥n

En Colombia la producci√≥n agricola se enfrenta a retos complejos como el cambio clim√°tico, la interrupci√≥n de suministros y la competencia externa. Factores como la inflaci√≥n, el aumento de precios de insumos, transporte, almacenamiento, fen√≥menos clim√°ticos y malos negocios con intermediarios terminan afectando al productor [2] (Portafolio). Por ejemplo, el diario Portafolio reporta que hace 18 meses producir una hect√°rea de papa costaba alrededor de \$22 millones y los valores de hoy est√°n cercanos a los \$40 millones por hect√°rea. Adem√°s de esto los peque√±os y medianos productores tienen que competir con importaciones de paises tecnificados donde la producci√≥n es mas econ√≥mica y eficiente. La papa es un caso importante, es un producto esencial para muchos hogares y hoy existe un exceso de oferta en comparaci√≥n con la demanda[1] (Razon publica).

Desde esta problem√°tica consideramos que es fundamental conocer las tendencias del mercado y los factores que afectan a los cultivos. En el siguiente proyecto realizamos algunos an√°lisis para ayudar a los productores a tomar desiciones informadas y que estas les permitan ser competitivos en el mercado. 

# **Metodolog√≠a**

## ¬øC√≥mo abordaremos el problema?

Utilizaremos datos hist√≥ricos de los precios de diferentes productos agricolas en diferentes centros mayoristas del pais, nos centramos en los datos producidos por el departamento nacional de estad√≠stica, DANE. Elegimos la **regi√≥n andina** de Colombia para acotar el problema, y tambi√©n nos enfocamos en  los productos cosechados en esta regi√≥n. Analizaremos la variabilidad del precio a lo largo del tiempo con el objetivo de identificar los productos m√°s estables, buscando identificar los productos que podr√≠an tener una rentabilidad m√°s segura. Usaremos datos de algunos factores relacionado en la cadena de producci√≥n o suministro, como la inflaci√≥n, los precios de diferentes insumos y los patrones de precios que siguen estos productos anualmente.

## ¬øQu√© medidas estad√≠sticas usaremos?

Para analizar los datos utilizaremos principalmente las medidas de tendencia central estad√≠stica como la media y la desviaci√≥n est√°ndar para medir la variabilidad de los productos a lo largo del tiempo. 
A su vez usaremos la correlaci√≥n para buscar posibles relaciones entre insumos y los productos.

## Nuestro objetivo: Generar recomendaciones para la producci√≥n agr√≠cola

El objetivo de nuestro proyecto es contribuir a la toma de decisiones informadas en la producci√≥n agr√≠cola de peque√±a o mediana escala, desde el an√°lisis de datos reales de variables relacionadas al precio de los productos.

## üìö Librer√≠as y funciones usadas

A continuaci√≥n un resumen de las librer√≠as usadas y su prop√≥sito.

| Librer√≠a     | Prop√≥sito |
| ------------ | --------- |
| RColorBrewer | Generaci√≥n de paletas de colores |
| readxl       | Lectura de archivos Excel |
| ggplot2      | Creaci√≥n de gr√°ficos estad√≠sticos |
| tidyverse    | Conjunto de herramientas para el an√°lisis de datos |
| cowplot      | Combinaci√≥n de gr√°ficos |
| lubridate    | Manejo de fechas y horas |
| patchwork    | Combinaci√≥n de gr√°ficos |
| tidyr        | Transformaci√≥n de datos |
| dplyr        | Selecci√≥n, manipulaci√≥n y agregaci√≥n de datos |
| lubridate    | Manejo de fechas y horas |
| skimr        | Exploraci√≥n de datos |
| kableExtra   | Mejorar la apariencia de las tablas generadas por la funci√≥n kable() de la librer√≠a knitr|
| knitr        | Generar documentos reproducibles en R que contengan c√≥digo R, texto, tablas y gr√°ficos |
| DT           | Crear tablas interactivas en R que pueden ser utilizadas para explorar datos de manera interactiva   |

```{r message=FALSE, warning=FALSE, echo=FALSE}
library("readxl") 
library("ggplot2") 
library("tidyverse") 
library(dplyr) 
library(tidyr) 
library(RColorBrewer) 
library(patchwork)
library(lubridate)
library(cowplot) 
library(skimr) 
library(kableExtra) 
library(knitr)
library(DT)  

# Cargar funciones 
source("funciones.R")
```
Definimos algunos par√°metros diccionarios y variables para los an√°lisis.

```{r setup, include=FALSE, echo=FALSE}
folder <- "datosRaw"

script_dir <- dirname(rstudioapi::getActiveDocumentContext()$path)
setwd(script_dir)

# Mapeo de ciudades andinas con su respectivo departamento (gracias chatgpt4)
ciudad_a_departamento <- c("Bucaramanga" = "Santander",
                           "C√∫cuta" = "Norte de Santander",
                           "Ibagu√©" = "Tolima",
                           "Manizales" = "Caldas",
                           "Medell√≠n" = "Antioquia",
                           "Santa B√°rbara (Antioquia)" = "Antioquia",
                           "Tunja" = "Boyac√°",
                           "Bogot√°" = "Cundinamarca",
                           "La Ceja (Antioquia)" = "Antioquia",
                           "Popay√°n" = "Cauca",
                           "Rionegro (Antioquia)" = "Antioquia",
                           "Armenia" = "Quind√≠o",
                           "Duitama (Boyac√°)" = "Boyac√°",
                           "Marinilla (Antioquia)" = "Antioquia",
                           "Neiva" = "Huila",
                           "Pe√±ol (Antioquia)" = "Antioquia",
                           "Pereira" = "Risaralda",
                           "San Vicente (Antioquia)" = "Antioquia",
                           "Sogamoso (Boyac√°)" = "Boyac√°",
                           "Sons√≥n (Antioquia)" = "Antioquia",
                           "Chiquinquir√° (Boyac√°)" = "Boyac√°",
                           "La Virginia (Risaralda)" = "Risaralda",
                           "Palmira (Valle del Cauca)" = "Valle del Cauca",
                           "El Santuario (Antioquia)" = "Antioquia",
                           "El Carmen de Viboral (Antioquia)" = "Antioquia",
                           "La Uni√≥n (Antioquia)" = "Antioquia",
                           "Tibasosa (Boyac√°)" = "Boyac√°")
abreviaciones_meses <- c(
  "ene", "feb", "mar", "abr", "may", "jun",
  "jul", "ago", "sep", "oct", "nov", "dic"
)

months <- c("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto",
            "Septiembre", "Octubre", "Noviembre", "Diciembre")
```

# üóí Datos


## üíæ‚Äã Fuentes: obtener los datos

En nuestros an√°lisis utilizamos conjuntos de datos de dos fuentes

1. DANE (2023) Sistema de Informaci√≥n de Precios y Abastecimiento del Sector Agropecuario (SIPSA). Gobierno de Colombia. Recuperado el 15 de Noviembre de 2023 de: https://www.dane.gov.co/index.php/estadisticas-por-tema/agropecuario/sistema-de-informacion-de-precios-sipsa#precios-mayoristas.  
2. DANE (2023) Inflacion total y meta. Banco de la Republica. Recuperado el 15 de Noviembre de 2023 de: https://www.banrep.gov.co/es/estadisticas/inflacion-total-y-meta

## Datos hist√≥ricos de precios mayoristas

Datos recolectados por el DANE como parte de la operaci√≥n SIPSA (Sistema de informaci√≥n de Precios y Abastecimiento) desde el 2012 hasta la fecha. Los conjuntos de datos disponbles son: Precios Mayoristas, Abastecimientos de Alimentos e Insumos y Factores Asociados a la Producci√≥n Agropecuaria. Estos datos se recolectan mediante entrevista personal con formulario de papel, en el siguiente enlace se encuentra la ficha t√©cnica https://microdatos.dane.gov.co/index.php/catalog/776

Las series hist√≥ricas de precios mayoristas tienen 5 variables, la fecha en la cual se tom√≥ la medici√≥n del precio del producto, el grupo al que pertenece el producto, el producto como tal, el mercado en donde se tom√≥ la medici√≥n y el precio promedio por kilogramo.

A continuaci√≥n informaci√≥n sobre los datos.

```{r, echo=FALSE}
nombre_archivo <- "datosRaw/precios_historico_productos_2013-2023_modificado.xlsx"
# a R le dio por no querrer leer el archivo con el path relativo
#nombre_archivo <- "D:/UIS SEXTO SEMESTRE/ESTADISTICA/proyectoE1-23/datosRaw/precios_historico_productos_2013-2023_modificado.xlsx"

file = nombre_archivo
sheets <- excel_sheets(file)
datos <- readxl::read_xlsx(file, sheet = sheets[1])

#Correcci√≥n por cambio en el grupo de tub√©rculos 
datos <- datos %>%
  mutate(Grupo = ifelse(Grupo == "TUB√âRCULOS, RA√çCES Y PL√ÅTANOS" , "TUBERCULOS, RAICES Y PLATANOS", Grupo))

print("N√∫mero de campos NaN")
sum(is.na(datos))

# quitando todos los datos NA
datos <- na.omit(datos)

# visualizacion de los daticos :3
s = summary(datos)
unique_counts <- sapply(datos, function(col) length(unique(col)))

kable(s, format = "markdown", caption="Caracter√≠sticas del dataset")
kable(unique_counts, format = "markdown", caption= "Valores √∫nicos por columna")

# para que no sufra R solo pongo poquitos
datos2023 <- filter(datos, year(Fecha) == 2023)
datatable(datos2023[0:1000,], caption = 'Datos precios productos 2023')

print(paste("Total filas ", nrow(datos)))

```

## Datos hist√≥ricos de insumos

La seres hist√≥ricas de insumos tienen dos distintos sets de variables, ya que la tercer hoja del documento alberga el listado de los insumos, con 3 variables, el grupo del insumo, el subgrupo y el nombre del insumo/factor. Luego las dem√°s hojas representan cada una un subgrupo ya establecido en la hoja del listado, estas cuentan con 8 variables, el a√±o en que se tom√≥ la medida, el mes, el codigo del departamento, el nombre del departamento, el codigo del municipio, el nombre del municipio, el nombre del producto, la presentaci√≥n del producto y el precio promedio.

Leemos los archivos y damos un primer vistazo a los datos.

```{r, echo=FALSE}
insumos2023 <- readxl::read_xlsx(paste(folder, "/series-historicas-insumos-2021-2023.xlsx", sep = ""), sheet = 5, range = "A9:I61985")
insumos2020 <- readxl::read_xlsx(paste(folder, "/series-historicas-insumos-2013-2020.xlsx", sep = ""), sheet = 5, range = "A10:I99845")

insumos <- rbind.data.frame(insumos2020, insumos2023)
```

```{r, echo=FALSE}
head(insumos) 
tail(insumos)
```
```{r, echo=FALSE}
print("Variables disponibles")
names(insumos)
```

Convertimos la fecha a una nueva columna en formato *YYYY-MM-DD*.

```{r, echo=FALSE}
# Convertir Columna mes a n√∫mero de mes
insumos$Mes <- match(insumos$Mes, months)

# Crear columan con fecha
insumos$Fecha <- paste(insumos$A√±o, insumos$Mes, '1', sep = "-")
insumos$Fecha <- as.Date(insumos$Fecha, format = "%Y-%m-%d")
```

N√∫mero de NaN:

```{r, echo=FALSE}
sum(is.na(insumos))
```

Algunos par√°metros estad√≠sticos.

```{r, echo=FALSE}
summary(insumos$'Precio promedio') # Para una columna espec√≠fica
skim(insumos)
```

Productos presentes en el dataset:

```{r, echo=FALSE}
nombres_insumos <- unique(insumos$`Nombre del producto`)

# Imprimir los valores √∫nicos con kable
kable(paste(nombres_insumos, collapse = ", "), format = "markdown", col.names = c( "Insumos reportados"))

```

Municipios de los que se tienen datos.

```{r, echo=FALSE}
nombres_insumos_municipios <- unique(insumos$`Nombre municipio`)

# Imprimir los valores √∫nicos con kable
kable(paste(nombres_insumos_municipios, collapse = ", "), format = "markdown", col.names = c( "Municipio con reporte de datos para insumos"))

```

Cambiamos el nombre de las columnas para facilitar el trabajo y filtramos los datos para los departamentos andinos.

```{r}
departamentos_andinos <- c("Antioquia", "Boyac√°", "Cundinamarca", "Norte de Santander", "Santander", 
                           "Tolima", "Huila", "Caldas", "Quind√≠o", "Risaralda", "Nari√±o")

# cambiando nombres de columnas a algo mas amigable
insumos$Departamento <- insumos$`Nombre departamento`
insumos <- insumos[, !names(insumos) %in% 'Nombre departamento']

insumos$Insumo <- insumos$`Nombre del producto`
insumos <- insumos[, !names(insumos) %in% 'Nombre del producto']


insumos_andino <- insumos %>%
  filter(Departamento %in% departamentos_andinos)
```
```{r, echo=FALSE}
print("N√∫mero de registros de insumos andinos")
nrow(insumos_andino)

```

## Datos hist√≥ricos de abastecimiento

Las series hist√≥ricas de abastecimiento tienen 38 variables, la fecha en la cual se tom√≥ la medici√≥n, el total de abastecimiento, la variaci√≥n mensual del abastecimiento, la variaci√≥n anual del abastecimiento, dos variables de empalme, y de la n√∫mero 7 a la 38 son distintos mercados en donde se tiene el valor de abastecimiento.

Inicialmente pensamos en relacionar el precio de los productos con los datos de abastecimiento, sin embargo, al revisar los datos de abastecimeinto notamos que el valor era un dato global. Por esta raz√≥n decidimos abandonar los an√°lisis. La exploraci√≥n inicial la realizamos con el script `scripts/preciosvsBodegas.R` 

##üßπ‚Äã Extaracci√≥n y limpieza

En t√©rminos t√©cnicos los datos se encuentran en hojas de c√°lculo formato Excel, separados por periodos en diferentes archivos y/o hojas de c√°lculo. Para usarlos y entenderlos de una manera m√°s eficiente, creamos un archivo agrupado, el script usado se encuentra en el directorio `scripts`. Adem√°s de esto, fue necesario hacer conversiones en las variables de fechas para poder realizar los an√°lisis, especialmente las gr√°ficas y la busqueda de relaciones. 

La exploraci√≥n inicial la realizamos de manera visual, el tama√±o de los archivos nos permitio visualizarlo y entre otras cosas identificar las hojas y rangos en los que se encontraban los datos de inter√©s.

# üìä‚Äã Visualizaci√≥n: ¬øQu√© tenemos?

## Agrupar datos

Ya que hemos eliminado los datos nulos y arreglado los datos podemos ver que tienen.
```{r}
print(names(datos))
```

Nos aseguramos de que **por cada a√±o hay aproximadamente la misma cantidad de filas**. A excepci√≥n de 2023 ya que los datos solo est√°n hasta Octubre.

```{r, echo=FALSE}
grouped_data <- datos %>%
  group_by(year = year(Fecha)) %>%
  summarise(Count = n()) %>%
  mutate(Percentage = Count / sum(Count) * 100)

grouped_data$year <- as.factor(grouped_data$year)

ggplot(grouped_data, aes(x="", y=Percentage, fill=year, group=year)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start=0) +
  theme_void() +
  theme(legend.position = "none") +
  geom_text(aes(x = 1.6, label = paste(year, '\n', round(Percentage, 2), "%")), 
            position = position_stack(vjust = 0.5)) +
  labs(title="Porcentaje de informaci√≥n por a√±o")
```

Los 8 grupos de productos que tenemos estan distribuidos como se muestra en la figura. Nos centraremos principalmente en los **productos agricolas que represntan alrededor del 60% de los productos en el dataset.**

```{r, echo=FALSE}
# productos de agricultura
grupos_select <- c("TUBERCULOS, RAICES Y PLATANOS", "VERDURAS Y HORTALIZAS","FRUTAS", "GRANOS Y CEREALES"   )

# Porcentaje de informacion por cada grupo
grupos_porcentaje <- datos %>%
  group_by(Grupo) %>%
  summarise(Count = n()) %>%
  mutate(Percentage = Count / sum(Count) * 100)

#Diagrama de pie
ggplot(grupos_porcentaje, aes(x="", y=Percentage, fill=Grupo)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start=0) +
  theme_void() +
  geom_text(aes(x = 1.6,label = paste(round(Percentage, 2), "%")), 
            position = position_stack(vjust = 0.5)) +
    labs(title="Porcentaje de informaci√≥n por cada grupo de productos")

agricola <- grupos_porcentaje %>%
  filter(Grupo %in% grupos_select)

s = sum(agricola$Percentage)
print(paste("Porcentaje productos agricolas", round(s,2)))

```

En el grupo de productos agricolas **tenemos estos productos:**
```{r, echo=FALSE}
# Ver productos
# Una tabla con los productos de cada grupo
datos_agricola <- datos %>%
  filter(Grupo %in% grupos_select)

unique_values_table <- datos_agricola %>%
  group_by(Grupo) %>%
  summarize(Productos = toString(unique(Producto)))

# Imprimir la tabla
unique_values_table %>%
  kable("html") %>%
  kable_styling(full_width = FALSE)
```

Adem√°s revisamos que tenemos muchas ciudades y mercados:
```{r}
print(paste("Ciudades : ", length(unique(datos$Ciudad))))
```

## ‚úÇÔ∏è‚ÄãReducci√≥n el tama√±o del dataset: Regi√≥n andina

Ya que tenemos una gran cantidades de datos, **decidimos centrarnos en los principales productos de la regi√≥n andina de Colombia**. Investigando en internet decidimos quedarnos con los **productos agricolas afines a esta regi√≥n**. Entonces basaremos nuestro an√°lisis en estos productos:

```{r, echo=FALSE}
ciudades_andinas <- c("Bucaramanga", "C√∫cuta", "Ibagu√©", "Manizales", "Medell√≠n", 
                      "Santa B√°rbara (Antioquia)", "Tunja", "Bogot√°", "La Ceja (Antioquia)", 
                      "Popay√°n", "Rionegro (Antioquia)", "Armenia", "Duitama (Boyac√°)", 
                      "Marinilla (Antioquia)", "Neiva", "Pe√±ol (Antioquia)", "Pereira", 
                      "San Vicente (Antioquia)", "Sogamoso (Boyac√°)", "Sons√≥n (Antioquia)", 
                      "Chiquinquir√° (Boyac√°)", "La Virginia (Risaralda)", "Palmira (Valle del Cauca)", 
                      "El Santuario (Antioquia)", "El Carmen de Viboral (Antioquia)", 
                      "La Uni√≥n (Antioquia)", "Tibasosa (Boyac√°)")

# productos que se pueden producir en la region andina colombiana
productos_list <- c(
  "Aguacate com√∫n", "Aguacate Hass", "Aguacate papelillo", "Curuba",
  "Curuba redonda", "Feijoa", "Fresa", "Granadilla", "Guayaba agria","Guan√°bana",
  "Maracuy√°", "Papaya Maradol","Pi√±a gold","Mango com√∫n",
  "Guayaba com√∫n", "Guayaba manzana", "Guayaba pera", "Higo",
  "Lulo", "Mora de Castilla", "Pera nacional", "Tomate de √°rbol",
  "Arracacha amarilla", "Arracacha blanca", "Papa capira",
  "Papa criolla limpia", "Papa criolla sucia", "Papa ICA-Huila",
  "Papa nevada", "Papa parda pastusa", "Papa Purac√©", "Papa rub√≠",
  "Papa R-12 negra", "Papa R-12 roja", "Papa sabanera", "Papa San F√©lix",
  "Papa suprema", "Papa tocana", "Papa tocarre√±a", "Papa √∫nica",
  "Pl√°tano comino", "Pl√°tano dominico hart√≥n maduro",
  "Pl√°tano dominico hart√≥n verde", "Pl√°tano dominico verde",
  "Pl√°tano guineo", "Pl√°tano hart√≥n maduro", "Pl√°tano hart√≥n verde",
  "Pl√°tano hart√≥n verde llanero", "Pl√°tano hart√≥n verde venezolano",
  "Ulluco", "Yuca chirosa", "Yuca criolla", "Yuca ICA",
  "Fr√≠jol nima calima", "Fr√≠jol radical", "Fr√≠jol Uribe rosado", "Fr√≠jol cargamento rojo", "Fr√≠jol cargamento blanco"
)
# Filtrar datos agro
datos_agro <- datos %>%
  filter(Ciudad %in% ciudades_andinas & Producto %in% productos_list)

# agregando la columna de departamento
datos_agro <- datos_agro %>% 
  mutate(Departamento = ciudad_a_departamento[Ciudad])


unique_values_table <- datos_agro %>%
  group_by(Grupo) %>%
  summarize(Productos = toString(unique(Producto)))

# Imprimir la tabla
unique_values_table %>%
  kable("html") %>%
  kable_styling(full_width = FALSE)

print(paste("Cantidad de productos: ",length(productos_list)))
print(paste("Cantidad de mercados ", length(unique(datos_agro$Mercado))))
```

## Comportamiento de los precios

Graficamos el comportamiento desde 2013 a 2023 de algunos productos buscando patrones anuales probablemente causados por el clima y la temporada en que se producen los productos:
```{r}
p1 = producto_comportamiento_tiempo("Aguacate papelillo")
p2 = producto_comportamiento_ciudades("Aguacate papelillo", 2023)
print(p1)
print(p2)
```

## Datos de insumos

Variables disponibles

```{r}
names(insumos)
```

Seleccionamos nitrogeno por ser este uno de los insumos m√°s usado en los planes de fertilizaci√≥n y generamos algunos gr√°ficos.

> Produto = Nitromag 21-0-0-7

```{r}
nitrogeno <- filter(insumos, Insumo == "Nitromag 21-0-0-7" & `Nombre municipio` == "Socorro")

hist(nitrogeno$`Precio promedio`, main = "Histograma Precio promedio")

# Historico 
plot(nitrogeno$Fecha, nitrogeno$`Precio promedio`, type = "l", main = "Historico de Nitrogeno para Socorro, Santander", xlab = "Fecha", ylab = "Precio")

# Historico suavizado
ggplot(nitrogeno, aes(x = Fecha, y = `Precio promedio`)) +
  geom_smooth(method = "loess", formula = y ~ x) +
  labs(title = "Historico de Nitrogeno para Socorro, Santander (Suavizado)", x = "Fecha", y = "Precio")
```

# üîç‚Äã **An√°lisis**

## üìâ‚Äã**Filtrar productos por variabilidad**

Ahora buscaremos los productos con menor y mayor variablidad en precio a lo largo del tiempo. Para esto **escribimos una funci√≥n para normalizar los precios de un producto respecto al m√°ximo precio de cada a√±o.** 
```{r}
# normalizar precios a nivel recional
normalizar_producto_tiempo <- function(nombre_producto){
  # Promedio mensual del precio a nivel regional
  promedios_regional <- datos_agro %>%
    filter(Producto == nombre_producto) %>%
    group_by(Fecha) %>%
    summarize(Promedio = mean(Precio))
  
  # Normalizar los precios para tener valores entre 0 y 1, mas faciles de comparar
  promedios_regional_normalizado <- promedios_regional %>%
    group_by(year = lubridate::year(Fecha)) %>%
    mutate(Promedio_normalizado = (Promedio / (max(Promedio, na.rm = TRUE))))
  
  return(promedios_regional_normalizado)
}
```
El c√≥digo que se muestra anteriormente hace lo siguiente: 

1.  Por cada producto en el dataset se agrupa por fecha y se obtiene el promedio del precio por a√±o-mes en toda la regi√≥n andina.

2. Se normalizan los valores por a√±o de cada producto. Los precios en 2013 ser√°n m√°s bajos que los de 2023 debido a la inflaci√≥n. Como queremos ver la variabilidad del producto normalizaremos  $precio\_normalizado = \frac{precio}{max(precio \ a√±o)}$

Con los valores normalizados que retorna esa funci√≥n podemos calcular la desviaci√≥n est√°ndar de los productos en el tiempo. Para verlo con un ejemplo con un par de productos:
```{r}
i = "Papa criolla limpia"
promedios_regional_normalizado = normalizar_producto_tiempo(i)
sd = sd(promedios_regional_normalizado$Promedio_normalizado, na.rm = TRUE)
h <- ggplot() + 
  geom_line(data = promedios_regional_normalizado, aes(x = Fecha, y = Promedio_normalizado), linewidth = 1) +
  labs(title = paste("Precio 2013-2023: ", i, "\n Desviaci√≥n est√°ndar: ", sd ),
       y="Precio")
print(h)


# para un producto que casi no cambia
i = "Fresa"
promedios_regional_normalizado = normalizar_producto_tiempo(i)
sd = sd(promedios_regional_normalizado$Promedio_normalizado, na.rm = TRUE)
h <- ggplot() + 
  geom_line(data = promedios_regional_normalizado, aes(x = Fecha, y = Promedio_normalizado), linewidth = 1) +
  labs(title = paste("Precio 2013-2023: ", i, "\n Desviaci√≥n est√°ndar: ", sd ),
       y="Precio")
print(h)
```

Ahora para todos los productos obtuvimos la desviaci√≥n est√°ndar, sin embargo notamos que habian varios productos que aparecen en muy pocas ciudades lo que nos da un resultado de baja confiabilidad.
```{r}
# Calcular desviacion estandar de los precios normalizados
df <- data.frame()

# Normalizar daticos agro por producto 
for (i in unique(datos_agro$Producto)) {
  
  # Ver por a√±o cuantas ciudades tienen ese producto en promedio
  numciudades <- promedioCiudades(i)
  
  # Obtener promedios regionales normalizados
  promedios_regional_normalizado = normalizar_producto_tiempo(i) 
    
  # Calcular desviacion estandar de los precios normalizados
  r <- data.frame(
    Producto = i,
    Promedio_normalizado = mean(promedios_regional_normalizado$Promedio_normalizado, na.rm = TRUE),
    Sd = sd(promedios_regional_normalizado$Promedio_normalizado, na.rm = TRUE),
    Num_ciudades = numciudades
  )
  # Agregar fila al dataframe de resultado
  df <- bind_rows(df, r)
}
```

```{r, echo = FALSE}
ggplot(df, aes(x = Producto, y = Num_ciudades )) +
  geom_bar(stat = "identity", fill = "skyblue", width = 0.7) +
  labs(
    title = "Numero de ciudades promedio que tienen un producto",
    x = "Producto",
    y = "Numero de ciudades"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Filtrando los productos que aparezcan en promedio al menos en 10 ciudades, **buscamos los productos con menor y mayor desviacion est√°ndar.**
```{r}
df <- filter(df, Num_ciudades > 10 )
# Obtenemos n los datos que menos y mas varian
n = 3
menor_sd <- (arrange(df,Sd))
mayor_sd <- (arrange(df,desc(Sd)))

ggplot(df, aes(x = Producto, y = Sd )) +
  geom_bar(stat = "identity", fill = "skyblue", width = 0.7) +
  labs(
    title = "Desviaci√≥n estandar del precio a lo largo del tiempo",
    x = "Producto",
    y = "Desviaci√≥n estandar"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


kable(head(menor_sd, 5), format = "markdown",  caption = "Productos con menor desviaci√≥n est√°ndar")
selectos_min <- filter(datos_agro, Producto %in%  menor_sd[0:n,]$Producto)


kable(head(mayor_sd,5), format = "markdown", caption = "Productos con mayor desviaci√≥n est√°ndar")
selectos_max <- filter(datos_agro, Producto %in%  mayor_sd[0:n,]$Producto)


# Grafica la variacion del precio a lo largo del tiempo
plot_min <- graficar_tiempo_producto(selectos_min, "Menor desviacion")
plot_mas <- graficar_tiempo_producto(selectos_max, "Mayor desviacion")

# para graficar en una sola figura
print(plot_min)
print(plot_mas)
```

Ahora graficando los comportamientos anuales de cada producto

### Productos con menor variabilidad
```{r}
# Graficar por cada producto
for(i in unique(selectos_min$Producto)) {
  plot1 <- producto_comportamiento_tiempo(i)
  print(plot1)
}

```

### Productos con mayor variabilidad
```{r}
# Graficar por cada producto
for(i in unique(selectos_max$Producto)) {
  plot1 <- producto_comportamiento_tiempo(i)
  print(plot1)
}

```

## üìà‚Äã **Correlaci√≥n con inflaci√≥n**

¬øQu√© tan afectados se ven los productos por la inflaci√≥n a nivel nacional?
Para responder esta pregunta:

1. Calculamos los promedios regionales de los productos para cada mes de 2013-2023

2. Obtenemos la correlaci√≥n  de cada producto con la tasa de inflaci√≥n a nivel nacional por mes

```{r}
d <- rbind(selectos_min, selectos_max)

promedios_regional <- d %>%
  group_by(Fecha, Producto) %>%
  summarize(Promedio = mean(Precio))

promedios_regional$Fecha =format(promedios_regional$Fecha, "%Y-%m-%d")

merged_inflacion <- merge(promedios_regional, datos_inflacion, by = c("Fecha"))

correlation_matrix <- merged_inflacion %>%
  group_by(Producto) %>%
  summarise(correlation = cor(Promedio, inflacionTotal, use = "complete.obs"))

# Ordenar de mayor a menor
correlation_matrix <- correlation_matrix %>%
  arrange(desc(correlation))

kable(correlation_matrix, format = "markdown", caption="Correlaci√≥n con tasa de inflaci√≥n a nivel nacional")
```


## üìà‚Äã **Correlaci√≥n con inflaci√≥n**

¬øQu√© tan afectados se ven los productos por la inflaci√≥n a nivel nacional?
Para responder esta pregunta:

1. Calculamos los promedios regionales de los productos para cada mes de 2013-2023

2. Obtenemos la correlaci√≥n  de cada producto con la tasa de inflaci√≥n a nivel nacional por mes

```{r}
d <- rbind(selectos_min, selectos_max)

promedios_regional <- d %>%
  group_by(Fecha, Producto) %>%
  summarize(Promedio = mean(Precio))

promedios_regional$Fecha =format(promedios_regional$Fecha, "%Y-%m-%d")

merged_inflacion <- merge(promedios_regional, datos_inflacion, by = c("Fecha"))

correlation_matrix <- merged_inflacion %>%
  group_by(Producto) %>%
  summarise(correlation = cor(Promedio, inflacionTotal, use = "complete.obs"))

# Ordenar de mayor a menor
correlation_matrix <- correlation_matrix %>%
  arrange(desc(correlation))

kable(correlation_matrix, format = "markdown", caption="Correlaci√≥n con tasa de inflaci√≥n a nivel nacional")
```


## üñáÔ∏è‚ÄãCorrelaci√≥n con fertilizantes

Seleccionamos 3 productos para ver su comportamiento respecto al precio del Nitrogeno.

```{r message=FALSE, warning=FALSE}
producto <- filter(datos, Ciudad == "Bucaramanga" & Mercado == "Bucaramanga, Centroabastos" & Producto == "Lulo")
producto2 <- filter(datos, Ciudad == "Bucaramanga" & Mercado == "Bucaramanga, Centroabastos" & Producto == "Fresa")
producto3 <- filter(datos, Ciudad == "Bucaramanga" & Mercado == "Bucaramanga, Centroabastos" & Producto == "Papa criolla limpia")


ggplot(producto, aes(x = Fecha, y = Precio)) +
  geom_smooth(method = "loess", formula = y ~ x, color = "orange", label = "Lulo") +
  geom_smooth(data = producto2, aes(x = Fecha, y = Precio), color = "green", label = "Fresa") +
  geom_smooth(data = producto3, aes(x = Fecha, y = Precio), color = "red", label = "Papa criolla") +
  labs(title = "Precio historico de los productos (Suavizado)", x = "Fecha", y = "Total")

```
Normalizamos los valores para graficar los productos y el precio del insumo.

```{r message=FALSE, warning=FALSE}
productoNorm <- producto %>%
  mutate(precio_normalizado = scale(Precio))
producto2Norm <- producto2 %>%
  mutate(precio_normalizado = scale(Precio))
producto3Norm <- producto3 %>%
  mutate(precio_normalizado = scale(Precio))
insumosNorm <- nitrogeno %>%
  mutate(total_normalizado = scale(`Precio promedio`))

productoNorm$Fecha <- as.Date(productoNorm$Fecha, format = "%Y-%m-%d")
producto2Norm$Fecha <- as.Date(producto2Norm$Fecha, format = "%Y-%m-%d")
producto3Norm$Fecha <- as.Date(producto3Norm$Fecha, format = "%Y-%m-%d")


ggplot(insumosNorm, aes(x = Fecha, y = total_normalizado)) +
  geom_smooth(method = "loess", formula = y ~ x) +
  geom_smooth(data = productoNorm, aes(x = Fecha, y = precio_normalizado, label = "Lulo"), color = "orange", label = "Lulo") +
  geom_smooth(data = producto2Norm, aes(x = Fecha, y = precio_normalizado, label = "Fresa"), color = "green") +
  geom_smooth(data = producto3Norm, aes(x = Fecha, y = precio_normalizado, label = "Papa criolla"), color = "red") +
  labs(title = "Nitrogeno y Precio de los Productos (Suavizado)", x = "Fecha", y = "Y")
```

### Correlaci√≥n

Buscamos si existe una correlacion entre el precio de los productos y los insumos

1. Merge de ambos datasets para solo tener los datos en comun

```{r}
merged_data <- merge(selectos_min, insumos_andino, by = c("Departamento", "Fecha"))

```

2. crear la matriz de correlacion y ordenar

```{r}
correlation_matrix <- merged_data %>%
  group_by(Producto, Insumo) %>%
  summarise(correlation = cor(Precio, `Precio promedio`, use = "complete.obs"))

# Ordenar de mayor a menor
correlation_matrix <- correlation_matrix %>%
  arrange(Producto, desc(abs(correlation)))
```

3. Filtrar los m primeros insumos de cada producto
```{r}
m = 3
top_correlations <- correlation_matrix %>%
  group_by(Producto) %>%
  top_n(m, wt = abs(correlation))


head(top_correlations)
```






