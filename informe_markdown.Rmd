---
html_document:
  theme: journal
  toc: yes
  toc_float: yes
  number_sections: yes
  code_folding: show
  
title: "Proyecto: Análisis de sensibilidad de del precio de productos agrícolas a factores externos"
author: "Paula Uzcategui | Sebastian Pedraza | Alexander Martinez"
output:
  html_document:
    df_print: paged
lang: "es-ES"
date: "2023 Dic 06"
---


# Introducción

### **La problemática**

En Colombia la producción agricola se enfrenta a retos complejos como el cambio climático, la interrupción de suministros y la competencia externa. Factores como la inflación, el aumento de precios de insumos, transporte, almacenamiento, fenómenos climáticos y malos negocios con intermediarios terminan afectando al productor [2] (Portafolio). Por ejemplo, el diario Portafolio reporta que hace 18 meses producir una hectárea de papa costaba alrededor de \$22 millones y los valores de hoy están cercanos a los \$40 millones por hectárea. Además de esto los pequeños y medianos productores tienen que competir con importaciones de paises tecnificados donde la producción es mas económica y eficiente. La papa es un caso importante, es un producto esencial para muchos hogares y hoy existe un exceso de oferta en comparación con la demanda[1] (Razon publica).

Desde esta problemática consideramos que es fundamental conocer las tendencias del mercado y los factores que afectan a los cultivos. En el siguiente proyecto realizamos algunos análisis para ayudar a los productores a tomar desiciones informadas y que estas les permitan ser competitivos en el mercado. 

### **¿Cómo abordaremos el problema?**

Utilizaremos datos históricos de los precios de diferentes productos agricolas en diferentes centros mayoristas del pais, nos centramos en los datos producidos por el departamento nacional de estadística, DANE. Elegimos la **región andina** de Colombia para acotar el problema, y también nos enfocamos en  los productos cosechados en esta región. Analizaremos la variabilidad del precio a lo largo del tiempo con el objetivo de identificar los productos más estables, buscando identificar los productos que podrían tener una rentabilidad más segura. Usaremos datos de algunos factores relacionado en la cadena de producción o suministro, como la inflación, los precios de diferentes insumos y los patrones de precios que siguen estos productos anualmente.

### **Técnica **

Para analizar los datos utilizaremos principalmente las medidas de tendencia central estadística como la media y la desviación estándar. Con estas identificaremos la variabilidad de los productos a lo largo del tiempo. A su vez usaremos la correlación para buscar posibles relaciones entre insumos y productos.

### **Ayudar a los productores**

El objetivo de nuestro proyecto es generar herramientas e información para apoyar la toma de desiciones en la actividades de producción agricola, con un enfoque en la producción de pequeña o mediana escala. 


## Los datos usados

En nuestros análisis utilizamos 2 conjuntos de datos principalmente.

1. DANE (2023) Sistema de Información de Precios y Abastecimiento del Sector Agropecuario (SIPSA). Gobierno de Colombia. Recuperado el 15 de Noviembre de 2023 de: https://www.dane.gov.co/index.php/estadisticas-por-tema/agropecuario/sistema-de-informacion-de-precios-sipsa#precios-mayoristas. 
2. DANE (2023) Inflacion total y meta. Banco de la Republica. Recuperado el 15 de Noviembre de 2023 de: https://www.banrep.gov.co/es/estadisticas/inflacion-total-y-meta


Datos recolectados por el DANE como parte de la operación SIPSA (Sistema de información de Precios y Abastecimiento) desde el 2012 hasta la fecha. Los conjuntos de datos disponbles son: Precios Mayoristas, Abastecimientos de Alimentos e Insumos y Factores Asociados a la Producción Agropecuaria.

Los datos de la inflación fueron recolectados por el DANE y esto se hizo con el fin de contrastar la inflación de precios al consumidor con la meta de la inflación fijada por la Junta Directiva del Banco de la Republica (JDBR)

### Datos productos, precios mayoristas

Las series históricas de precios mayoristas tienen 5 variables, la fecha en la cual se tomó la medición del precio del producto, el grupo al que pertenece el producto, el producto como tal, el mercado en donde se tomó la medición y el precio promedio por kilogramo.

### Datos de insumos

La seres históricas de insumos tienen dos distintos sets de variables, ya que la tercer hoja del documento alberga el listado de los insumos, con 3 variables, el grupo del insumo, el subgrupo y el nombre del insumo/factor. Luego las demás hojas representan cada una un subgrupo ya establecido en la hoja del listado, estas cuentan con 8 variables, el año en que se tomó la medida, el mes, el codigo del departamento, el nombre del departamento, el codigo del municipio, el nombre del municipio, el nombre del producto, la presentación del producto y el precio promedio.

### Datos de abastecimiento
Las series históricas de abastecimiento tienen 38 variables, la fecha en la cual se tomó la medición, el total de abastecimiento, la variación mensual del abastecimiento, la variación anual del abastecimiento, dos variables de empalme, y de la número 7 a la 38 son distintos mercados en donde se tiene el valor de abastecimiento.

### Datos de inflación
Las series historicas de la meta e inflacion total al consumidor tienen 5 variables, la fecha de la medición, la inflacion total al consumidor, la meta de inflacion y sus limites inferior y superior.

## Librerías usadas

A continuación un resumen de las librerías usadas y su propósito de uso

| Librería     | Propósito |
| ------------ | --------- |
| RColorBrewer | Generación de paletas de colores |
| readxl       | Lectura de archivos Excel |
| ggplot2      | Creación de gráficos estadísticos |
| tidyverse    | Conjunto de herramientas para el análisis de datos |
| cowplot      | Combinación de gráficos |
| lubridate    | Manejo de fechas y horas |
| patchwork    | Combinación de gráficos |
| tidyr        | Transformación de datos |
| dplyr        | Selección, manipulación y agregación de datos |
| lubridate    | Manejo de fechas y horas |
| skimr        | Exploración de datos |





## **Datos históricos de precios de productos**


```{r setup, include=FALSE}
#Librerias
library("readxl") # para leer archivos Excel
library("ggplot2") # para graficar
library("tidyverse") # para manejo de datos
library(dplyr) # para hacer joins
library(tidyr) # para reshape la tabla
library(RColorBrewer) # colorcitos de los plots
#install.packages("patchwork") # para poder combinar grafucis
library(patchwork) # para plotear multiples graficos en una figura
#install.packages("lubridate")
library(lubridate)
#install.packages("cowplot")
library(cowplot) # tambien para hacer multiples graficos pero diferente
library(skimr) # ver los summary mas bonito
#install.packages("kableExtra")
library(kableExtra) # mostrar tablas bonitas
library(knitr)
library(DT)           # for printing nice HTML output tables
#install.packages("DT")

script_dir <- dirname(rstudioapi::getActiveDocumentContext()$path)
setwd(script_dir)

# Mapeo de ciudades andinas con su respectivo departamento (gracias chatgpt4)
ciudad_a_departamento <- c("Bucaramanga" = "Santander",
                           "Cúcuta" = "Norte de Santander",
                           "Ibagué" = "Tolima",
                           "Manizales" = "Caldas",
                           "Medellín" = "Antioquia",
                           "Santa Bárbara (Antioquia)" = "Antioquia",
                           "Tunja" = "Boyacá",
                           "Bogotá" = "Cundinamarca",
                           "La Ceja (Antioquia)" = "Antioquia",
                           "Popayán" = "Cauca",
                           "Rionegro (Antioquia)" = "Antioquia",
                           "Armenia" = "Quindío",
                           "Duitama (Boyacá)" = "Boyacá",
                           "Marinilla (Antioquia)" = "Antioquia",
                           "Neiva" = "Huila",
                           "Peñol (Antioquia)" = "Antioquia",
                           "Pereira" = "Risaralda",
                           "San Vicente (Antioquia)" = "Antioquia",
                           "Sogamoso (Boyacá)" = "Boyacá",
                           "Sonsón (Antioquia)" = "Antioquia",
                           "Chiquinquirá (Boyacá)" = "Boyacá",
                           "La Virginia (Risaralda)" = "Risaralda",
                           "Palmira (Valle del Cauca)" = "Valle del Cauca",
                           "El Santuario (Antioquia)" = "Antioquia",
                           "El Carmen de Viboral (Antioquia)" = "Antioquia",
                           "La Unión (Antioquia)" = "Antioquia",
                           "Tibasosa (Boyacá)" = "Boyacá")

```
# 🗒️​Los datos



```{r, echo=FALSE}
nombre_archivo <- "datosRaw/precios_historico_productos_2013-2023_modificado.xlsx"
# a R le dio por no querrer leer el archivo con el path relativo
nombre_archivo <- "D:/UIS SEXTO SEMESTRE/ESTADISTICA/proyectoE1-23/datosRaw/precios_historico_productos_2013-2023_modificado.xlsx"

file = nombre_archivo
sheets <- excel_sheets(file)
datos <- readxl::read_xlsx(file, sheet = sheets[1])

#se nos paso el grupo de tuberculos tiene un nombre diferente para 2021 
datos <- datos %>%
  mutate(Grupo = ifelse(Grupo == "TUBÉRCULOS, RAÍCES Y PLÁTANOS" , "TUBERCULOS, RAICES Y PLATANOS", Grupo))

sum(is.na(datos))

# quitando todos los datos NA
datos <- na.omit(datos)

# visualizacion de los daticos :3

s = summary(datos)
unique_counts <- sapply(datos, function(col) length(unique(col)))

kable(s, format = "markdown")
print("Valores únicos por columna")
print(unique_counts)

# para que no sufra R solo pongo poquitos
datos2023 <- filter(datos, year(Fecha) == 2023)
datatable(datos2023[0:1000,], caption = 'Datos precios productos 2023')

print(paste("Total filas ", nrow(datos)))

```
###🧹​ Extaracción y limpieza



### 📊​ Visualización: ¿Qué tenemos?

Ya que hemos eliminado los datos nulos y arreglado los datos podemos ver que tienen.
```{r}
print(names(datos))
```

Nos aseguramos de que **por cada año hay aproximadamente la misma cantidad de filas**. A excepción de 2023 ya que los datos solo están hasta Octubre.

```{r, echo=FALSE}
grouped_data <- datos %>%
  group_by(year = year(Fecha)) %>%
  summarise(Count = n()) %>%
  mutate(Percentage = Count / sum(Count) * 100)

grouped_data$year <- as.factor(grouped_data$year)

ggplot(grouped_data, aes(x="", y=Percentage, fill=year, group=year)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start=0) +
  theme_void() +
  theme(legend.position = "none") +
  geom_text(aes(x = 1.6, label = paste(year, '\n', round(Percentage, 2), "%")), 
            position = position_stack(vjust = 0.5)) +
  labs(title="Porcentaje de información por año")
```

Los 8 grupos de productos que tenemos estan distribuidos como se muestra en la figura. Nos centraremos principalmente en los **productos agricolas que represntan alrededor del 60% de los productos en el dataset.**

```{r, echo=FALSE}
# productos de agricultura
grupos_select <- c("TUBERCULOS, RAICES Y PLATANOS", "VERDURAS Y HORTALIZAS","FRUTAS", "GRANOS Y CEREALES"   )

# Porcentaje de informacion por cada grupo
grupos_porcentaje <- datos %>%
  group_by(Grupo) %>%
  summarise(Count = n()) %>%
  mutate(Percentage = Count / sum(Count) * 100)

#Diagrama de pie
ggplot(grupos_porcentaje, aes(x="", y=Percentage, fill=Grupo)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start=0) +
  theme_void() +
  geom_text(aes(x = 1.6,label = paste(round(Percentage, 2), "%")), 
            position = position_stack(vjust = 0.5)) +
    labs(title="Porcentaje de información por cada grupo de productos")

agricola <- grupos_porcentaje %>%
  filter(Grupo %in% grupos_select)

s = sum(agricola$Percentage)
print(paste("Porcentaje productos agricolas", round(s,2)))

```

En el grupo de productos agricolas **tenemos estos productos:**
```{r, echo=FALSE}
# Ver productos
# Una tabla con los productos de cada grupo
datos_agricola <- datos %>%
  filter(Grupo %in% grupos_select)

unique_values_table <- datos_agricola %>%
  group_by(Grupo) %>%
  summarize(Productos = toString(unique(Producto)))

# Imprimir la tabla
unique_values_table %>%
  kable("html") %>%
  kable_styling(full_width = FALSE)
```

Además revisamos que tenemos muchas ciudades y mercados:
```{r}
print(paste("Ciudades : ", length(unique(datos$Ciudad))))
```

### ✂️​Reducir el tamaño del dataset: Región andina

Ya que tenemos una gran cantidades de datos, **decidimos centrarnos en los principales productos de la región andina de Colombia**. Investigando en internet decidimos quedarnos con los **productos agricolas afines a esta región**. Entonces basaremos nuestro análisis en estos productos:

```{r, echo=FALSE}
ciudades_andinas <- c("Bucaramanga", "Cúcuta", "Ibagué", "Manizales", "Medellín", 
                      "Santa Bárbara (Antioquia)", "Tunja", "Bogotá", "La Ceja (Antioquia)", 
                      "Popayán", "Rionegro (Antioquia)", "Armenia", "Duitama (Boyacá)", 
                      "Marinilla (Antioquia)", "Neiva", "Peñol (Antioquia)", "Pereira", 
                      "San Vicente (Antioquia)", "Sogamoso (Boyacá)", "Sonsón (Antioquia)", 
                      "Chiquinquirá (Boyacá)", "La Virginia (Risaralda)", "Palmira (Valle del Cauca)", 
                      "El Santuario (Antioquia)", "El Carmen de Viboral (Antioquia)", 
                      "La Unión (Antioquia)", "Tibasosa (Boyacá)")

# productos que se pueden producir en la region andina colombiana
productos_list <- c(
  "Aguacate común", "Aguacate Hass", "Aguacate papelillo", "Curuba",
  "Curuba redonda", "Feijoa", "Fresa", "Granadilla", "Guayaba agria","Guanábana",
  "Maracuyá", "Papaya Maradol","Piña gold","Mango común",
  "Guayaba común", "Guayaba manzana", "Guayaba pera", "Higo",
  "Lulo", "Mora de Castilla", "Pera nacional", "Tomate de árbol",
  "Arracacha amarilla", "Arracacha blanca", "Papa capira",
  "Papa criolla limpia", "Papa criolla sucia", "Papa ICA-Huila",
  "Papa nevada", "Papa parda pastusa", "Papa Puracé", "Papa rubí",
  "Papa R-12 negra", "Papa R-12 roja", "Papa sabanera", "Papa San Félix",
  "Papa suprema", "Papa tocana", "Papa tocarreña", "Papa única",
  "Plátano comino", "Plátano dominico hartón maduro",
  "Plátano dominico hartón verde", "Plátano dominico verde",
  "Plátano guineo", "Plátano hartón maduro", "Plátano hartón verde",
  "Plátano hartón verde llanero", "Plátano hartón verde venezolano",
  "Ulluco", "Yuca chirosa", "Yuca criolla", "Yuca ICA",
  "Yuca llanera", "Maíz amarillo cáscara", "Maíz amarillo trillado", "Maíz blanco trillado",
  "Fríjol nima calima", "Fríjol radical", "Fríjol Uribe rosado", "Fríjol cargamento rojo", "Fríjol cargamento blanco"
)
# Filtrar datos agro
datos_agro <- datos %>%
  filter(Ciudad %in% ciudades_andinas & Producto %in% productos_list)

# agregando la columna de departamento
datos_agro <- datos_agro %>% 
  mutate(Departamento = ciudad_a_departamento[Ciudad])


unique_values_table <- datos_agro %>%
  group_by(Grupo) %>%
  summarize(Productos = toString(unique(Producto)))

# Imprimir la tabla
unique_values_table %>%
  kable("html") %>%
  kable_styling(full_width = FALSE)

print(paste("Cantidad de productos: ",length(productos_list)))
print(paste("Cantidad de mercados ", length(unique(datos_agro$Mercado))))
```

## Datos históricos de precios de insumos
```{r, echo=FALSE}


```


Mostrar que hay o como se ven -> insumos_andino
```{r}

```



# 🔍​Análisis







