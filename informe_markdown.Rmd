---
html_document:
  theme: journal
  toc: yes
  toc_float: yes
  number_sections: yes
  code_folding: show
  
title: "Proyecto: An√°lisis de sensibilidad de del precio de productos agr√≠colas a factores externos"
output:
  html_document:
    df_print: paged
lang: "es-ES"
---

# **Introducci√≥n**

### **La problem√°tica**

En Colombia los productores del campo se enfrentan a retos complejos como el cambio clim√°tico, la interrupci√≥n de suministros y la competencia externa.
Factores como la inflaci√≥n, el aumento de precios de insumos, transporte, almacenamiento, fen√≥menos clim√°ticos y malos negocios con intermediarios terminan afectando al productor [2] (Portafolio)
El periodico portafolio reporta que hace 18 meses producir una hect√°rea de papa costaba alrededor de \$22 millones y los valores de hoy est√°n cercanos a los \$40 millones por hect√°rea.

Adem√°s de esto los peque√±os y medianos productores tienen que competir con importaciones de paises tecnificados donde la producci√≥n es mas barata y los precios m√°s bajos que los nacionales, como sucede en el caso de la papa, donde hoy existe un exceso de oferta en comparaci√≥n con la demanda[1] (Razon publica)

A partir de esta problem√°tica consideramos que es fundamental conocer las tendencias del mercado y los factores que afectan a los cultivos, para ayudar a los productores a tomar desiciones informadas que les permitan ser competitivos en el mercado. 

### **¬øC√≥mo abordaremos el problema?**

Utilizaremos datos hist√≥ricos y actuales de los precios de diferentes productos agricolas en diferentes centros mayoristas del pais sacados de la p√°gina del DANE. Enfocandonos principalmente en la **regi√≥n andina** de Colombia, buscaremos aquellos productos que se pueden cultivar en esta regi√≥n y analizaremos su variabilidad a lo largo del tiempo, con el objetivo de identificar los productos con mayor y menor variabilidad, es decir aquellos con los que probablemente se deber√≠a ser m√°s cuidadosos y aquellos que posiblemente ser√≠a buena idea considerar. Adem√°s contrastaremos nuestros hallazgos con factores externos como la inflaci√≥n, los precios de diferentes insumos y los patrones de precios que siguen estos productos anualmente, tal vez debido al clima.

### **¬øQu√© medidas estad√≠sticas usaremos?**

Para analizar los datos utilizaremos principalmente las medidas de tendencia central estad√≠stica como la media y la desviaci√≥n est√°ndar para medir la variabilidad de los productos a lo largo del tiempo. 
A su vez usaremos la correlaci√≥n para buscar posibles relaciones entre insumos y los productos.

### **Nuestro objetivo: ayudar a los productores**

El objetivo de nuestro proyecto es poder ayudar a los productores del campo a tomar desiciones informadas acerca de los cultivos basado en datos reales. 


# üóí **Datos**

## üìö **Librer√≠as**

(esto cambiarlo por como lo tiene alex)

```{r}
#Librerias
library("readxl") # para leer archivos Excel
library("ggplot2") # para graficar
library("tidyverse") # para manejo de datos
library(dplyr) # para hacer joins
library(tidyr) # para reshape la tabla
library(RColorBrewer) # colorcitos de los plots
#install.packages("patchwork") # para poder combinar grafucis
library(patchwork) # para plotear multiples graficos en una figura
#install.packages("lubridate")
library(lubridate)
#install.packages("cowplot")
library(cowplot) # tambien para hacer multiples graficos pero diferente
library(skimr) # ver los summary mas bonito
#install.packages("kableExtra")
library(kableExtra) # mostrar tablas bonitas
library(knitr)
library(DT)           # for printing nice HTML output tables
#install.packages("DT")

# Cargar funciones 
source("funciones.R")
```

esto no quitarlo:
```{r setup, include=FALSE}


script_dir <- dirname(rstudioapi::getActiveDocumentContext()$path)
setwd(script_dir)

# Mapeo de ciudades andinas con su respectivo departamento (gracias chatgpt4)
ciudad_a_departamento <- c("Bucaramanga" = "Santander",
                           "C√∫cuta" = "Norte de Santander",
                           "Ibagu√©" = "Tolima",
                           "Manizales" = "Caldas",
                           "Medell√≠n" = "Antioquia",
                           "Santa B√°rbara (Antioquia)" = "Antioquia",
                           "Tunja" = "Boyac√°",
                           "Bogot√°" = "Cundinamarca",
                           "La Ceja (Antioquia)" = "Antioquia",
                           "Popay√°n" = "Cauca",
                           "Rionegro (Antioquia)" = "Antioquia",
                           "Armenia" = "Quind√≠o",
                           "Duitama (Boyac√°)" = "Boyac√°",
                           "Marinilla (Antioquia)" = "Antioquia",
                           "Neiva" = "Huila",
                           "Pe√±ol (Antioquia)" = "Antioquia",
                           "Pereira" = "Risaralda",
                           "San Vicente (Antioquia)" = "Antioquia",
                           "Sogamoso (Boyac√°)" = "Boyac√°",
                           "Sons√≥n (Antioquia)" = "Antioquia",
                           "Chiquinquir√° (Boyac√°)" = "Boyac√°",
                           "La Virginia (Risaralda)" = "Risaralda",
                           "Palmira (Valle del Cauca)" = "Valle del Cauca",
                           "El Santuario (Antioquia)" = "Antioquia",
                           "El Carmen de Viboral (Antioquia)" = "Antioquia",
                           "La Uni√≥n (Antioquia)" = "Antioquia",
                           "Tibasosa (Boyac√°)" = "Boyac√°")
abreviaciones_meses <- c(
  "ene", "feb", "mar", "abr", "may", "jun",
  "jul", "ago", "sep", "oct", "nov", "dic"
)
```

## üíæ‚Äã **Fuentes: obtener los datos**

( esto es lo que esta haciendo sebastian)
.
.
.



## üëÄ **Un primer vistazo**
(para poner los head y los summary)

### Datos hist√≥ricos de precios en tiendas

```{r, echo=FALSE}
nombre_archivo <- "datosRaw/precios_historico_productos_2013-2023_modificado.xlsx"
# a R le dio por no querrer leer el archivo con el path relativo
nombre_archivo <- "D:/UIS SEXTO SEMESTRE/ESTADISTICA/proyectoE1-23/datosRaw/precios_historico_productos_2013-2023_modificado.xlsx"

file = nombre_archivo
sheets <- excel_sheets(file)
datos <- readxl::read_xlsx(file, sheet = sheets[1])

#se nos paso el grupo de tuberculos tiene un nombre diferente para 2021 
datos <- datos %>%
  mutate(Grupo = ifelse(Grupo == "TUB√âRCULOS, RA√çCES Y PL√ÅTANOS" , "TUBERCULOS, RAICES Y PLATANOS", Grupo))

sum(is.na(datos))

# quitando todos los datos NA
datos <- na.omit(datos)

# visualizacion de los daticos :3

s = summary(datos)
unique_counts <- sapply(datos, function(col) length(unique(col)))

kable(s, format = "markdown", caption="Caracter√≠sticas del dataset")
kable(unique_counts, format = "markdown", caption= "Valores √∫nicos por columna")

# para que no sufra R solo pongo poquitos
datos2023 <- filter(datos, year(Fecha) == 2023)
datatable(datos2023[0:1000,], caption = 'Datos precios productos 2023')

print(paste("Total filas ", nrow(datos)))

```

### Datos hist√≥ricos de insumos

.
.
.


### Datos hist√≥ricos de abastecimiento

.
.
.





##üßπ‚Äã **Extaracci√≥n y limpieza**

(explicar como los sacamos de los archivos de excel y todo el cuento)
.
.
.


## üìä‚Äã **Visualizaci√≥n: ¬øQu√© tenemos?**

Ya que hemos eliminado los datos nulos y arreglado los datos podemos ver que tienen.
```{r}
print(names(datos))
```

Nos aseguramos de que **por cada a√±o hay aproximadamente la misma cantidad de filas**. A excepci√≥n de 2023 ya que los datos solo est√°n hasta Octubre.

```{r, echo=FALSE}
grouped_data <- datos %>%
  group_by(year = year(Fecha)) %>%
  summarise(Count = n()) %>%
  mutate(Percentage = Count / sum(Count) * 100)

grouped_data$year <- as.factor(grouped_data$year)

ggplot(grouped_data, aes(x="", y=Percentage, fill=year, group=year)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start=0) +
  theme_void() +
  theme(legend.position = "none") +
  geom_text(aes(x = 1.6, label = paste(year, '\n', round(Percentage, 2), "%")), 
            position = position_stack(vjust = 0.5)) +
  labs(title="Porcentaje de informaci√≥n por a√±o")
```

Los 8 grupos de productos que tenemos estan distribuidos como se muestra en la figura. Nos centraremos principalmente en los **productos agricolas que represntan alrededor del 60% de los productos en el dataset.**

```{r, echo=FALSE}
# productos de agricultura
grupos_select <- c("TUBERCULOS, RAICES Y PLATANOS", "VERDURAS Y HORTALIZAS","FRUTAS", "GRANOS Y CEREALES"   )

# Porcentaje de informacion por cada grupo
grupos_porcentaje <- datos %>%
  group_by(Grupo) %>%
  summarise(Count = n()) %>%
  mutate(Percentage = Count / sum(Count) * 100)

#Diagrama de pie
ggplot(grupos_porcentaje, aes(x="", y=Percentage, fill=Grupo)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start=0) +
  theme_void() +
  geom_text(aes(x = 1.6,label = paste(round(Percentage, 2), "%")), 
            position = position_stack(vjust = 0.5)) +
    labs(title="Porcentaje de informaci√≥n por cada grupo de productos")

agricola <- grupos_porcentaje %>%
  filter(Grupo %in% grupos_select)

s = sum(agricola$Percentage)
print(paste("Porcentaje productos agricolas", round(s,2)))

```

En el grupo de productos agricolas **tenemos estos productos:**
```{r, echo=FALSE}
# Ver productos
# Una tabla con los productos de cada grupo
datos_agricola <- datos %>%
  filter(Grupo %in% grupos_select)

unique_values_table <- datos_agricola %>%
  group_by(Grupo) %>%
  summarize(Productos = toString(unique(Producto)))

# Imprimir la tabla
unique_values_table %>%
  kable("html") %>%
  kable_styling(full_width = FALSE)
```

Adem√°s revisamos que tenemos muchas ciudades y mercados:
```{r}
print(paste("Ciudades : ", length(unique(datos$Ciudad))))
```


### ‚úÇÔ∏è‚ÄãReducir el tama√±o del dataset: Regi√≥n andina

Ya que tenemos una gran cantidades de datos, **decidimos centrarnos en los principales productos de la regi√≥n andina de Colombia**. Investigando en internet decidimos quedarnos con los **productos agricolas afines a esta regi√≥n**. Entonces basaremos nuestro an√°lisis en estos productos:

```{r, echo=FALSE}
ciudades_andinas <- c("Bucaramanga", "C√∫cuta", "Ibagu√©", "Manizales", "Medell√≠n", 
                      "Santa B√°rbara (Antioquia)", "Tunja", "Bogot√°", "La Ceja (Antioquia)", 
                      "Popay√°n", "Rionegro (Antioquia)", "Armenia", "Duitama (Boyac√°)", 
                      "Marinilla (Antioquia)", "Neiva", "Pe√±ol (Antioquia)", "Pereira", 
                      "San Vicente (Antioquia)", "Sogamoso (Boyac√°)", "Sons√≥n (Antioquia)", 
                      "Chiquinquir√° (Boyac√°)", "La Virginia (Risaralda)", "Palmira (Valle del Cauca)", 
                      "El Santuario (Antioquia)", "El Carmen de Viboral (Antioquia)", 
                      "La Uni√≥n (Antioquia)", "Tibasosa (Boyac√°)")

# productos que se pueden producir en la region andina colombiana
productos_list <- c(
  "Aguacate com√∫n", "Aguacate Hass", "Aguacate papelillo", "Curuba",
  "Curuba redonda", "Feijoa", "Fresa", "Granadilla", "Guayaba agria","Guan√°bana",
  "Maracuy√°", "Papaya Maradol","Pi√±a gold","Mango com√∫n",
  "Guayaba com√∫n", "Guayaba manzana", "Guayaba pera", "Higo",
  "Lulo", "Mora de Castilla", "Pera nacional", "Tomate de √°rbol",
  "Arracacha amarilla", "Arracacha blanca", "Papa capira",
  "Papa criolla limpia", "Papa criolla sucia", "Papa ICA-Huila",
  "Papa nevada", "Papa parda pastusa", "Papa Purac√©", "Papa rub√≠",
  "Papa R-12 negra", "Papa R-12 roja", "Papa sabanera", "Papa San F√©lix",
  "Papa suprema", "Papa tocana", "Papa tocarre√±a", "Papa √∫nica",
  "Pl√°tano comino", "Pl√°tano dominico hart√≥n maduro",
  "Pl√°tano dominico hart√≥n verde", "Pl√°tano dominico verde",
  "Pl√°tano guineo", "Pl√°tano hart√≥n maduro", "Pl√°tano hart√≥n verde",
  "Pl√°tano hart√≥n verde llanero", "Pl√°tano hart√≥n verde venezolano",
  "Ulluco", "Yuca chirosa", "Yuca criolla", "Yuca ICA",
  "Yuca llanera", "Ma√≠z amarillo c√°scara", "Ma√≠z amarillo trillado", "Ma√≠z blanco trillado",
  "Fr√≠jol nima calima", "Fr√≠jol radical", "Fr√≠jol Uribe rosado", "Fr√≠jol cargamento rojo", "Fr√≠jol cargamento blanco"
)
# Filtrar datos agro
datos_agro <- datos %>%
  filter(Ciudad %in% ciudades_andinas & Producto %in% productos_list)

# agregando la columna de departamento
datos_agro <- datos_agro %>% 
  mutate(Departamento = ciudad_a_departamento[Ciudad])


unique_values_table <- datos_agro %>%
  group_by(Grupo) %>%
  summarize(Productos = toString(unique(Producto)))

# Imprimir la tabla
unique_values_table %>%
  kable("html") %>%
  kable_styling(full_width = FALSE)

print(paste("Cantidad de productos: ",length(productos_list)))
print(paste("Cantidad de mercados ", length(unique(datos_agro$Mercado))))
```


Graficamos el comportamiento desde 2013 a 2023 de algunos productos buscando patrones anuales probablemente causados por el clima y la temporada en que se producen los productos:
```{r}
p1 = producto_comportamiento_tiempo("Aguacate papelillo")
p2 = producto_comportamiento_ciudades("Aguacate papelillo", 2023)
print(p1)
print(p2)
```


### mostra que es lo que hay en los insumos, visualizacion de los fertilizantes



# üîç‚Äã **An√°lisis**

## üìâ‚Äã**Filtrar productos por variabilidad**

Ahora buscaremos los productos con menor y mayor variablidad en precio a lo largo del tiempo. Para esto **escribimos una funci√≥n para normalizar los precios de un producto respecto al m√°ximo precio de cada a√±o.** 
```{r}
# normalizar precios a nivel recional
normalizar_producto_tiempo <- function(nombre_producto){
  # Promedio mensual del precio a nivel regional
  promedios_regional <- datos_agro %>%
    filter(Producto == nombre_producto) %>%
    group_by(Fecha) %>%
    summarize(Promedio = mean(Precio))
  
  # Normalizar los precios para tener valores entre 0 y 1, mas faciles de comparar
  promedios_regional_normalizado <- promedios_regional %>%
    group_by(year = lubridate::year(Fecha)) %>%
    mutate(Promedio_normalizado = (Promedio / (max(Promedio, na.rm = TRUE))))
  
  return(promedios_regional_normalizado)
}
```
El c√≥digo que se muestra anteriormente hace lo siguiente: 

1.  Por cada producto en el dataset se agrupa por fecha y se obtiene el promedio del precio por a√±o-mes en toda la regi√≥n andina.

2. Se normalizan los valores por a√±o de cada producto. Los precios en 2013 ser√°n m√°s bajos que los de 2023 debido a la inflaci√≥n. Como queremos ver la variabilidad del producto normalizaremos  $precio\_normalizado = \frac{precio}{max(precio \ a√±o)}$

Con los valores normalizados que retorna esa funci√≥n podemos calcular la desviaci√≥n est√°ndar de los productos en el tiempo. Para verlo con un ejemplo con un par de productos:
```{r}
i = "Papa criolla limpia"
promedios_regional_normalizado = normalizar_producto_tiempo(i)
sd = sd(promedios_regional_normalizado$Promedio_normalizado, na.rm = TRUE)
h <- ggplot() + 
  geom_line(data = promedios_regional_normalizado, aes(x = Fecha, y = Promedio_normalizado), linewidth = 1) +
  labs(title = paste("Precio 2013-2023: ", i, "\n Desviaci√≥n est√°ndar: ", sd ),
       y="Precio")
print(h)


# para un producto que casi no cambia
i = "Fresa"
promedios_regional_normalizado = normalizar_producto_tiempo(i)
sd = sd(promedios_regional_normalizado$Promedio_normalizado, na.rm = TRUE)
h <- ggplot() + 
  geom_line(data = promedios_regional_normalizado, aes(x = Fecha, y = Promedio_normalizado), linewidth = 1) +
  labs(title = paste("Precio 2013-2023: ", i, "\n Desviaci√≥n est√°ndar: ", sd ),
       y="Precio")
print(h)
```

Ahora para todos los productos obtuvimos la desviaci√≥n est√°ndar, sin embargo notamos que habian varios productos que aparecen en muy pocas ciudades lo que no nos da un resultado muy confiable
```{r}
# Calcular desviacion estandar de los precios normalizados
df <- data.frame()

# Normalizar daticos agro por producto 
for (i in unique(datos_agro$Producto)) {
  
  # Ver por a√±o cuantas ciudades tienen ese producto en promedio
  numciudades <- promedioCiudades(i)
  
  # Obtener promedios regionales normalizados
  promedios_regional_normalizado = normalizar_producto_tiempo(i) 
    
  # Calcular desviacion estandar de los precios normalizados
  r <- data.frame(
    Producto = i,
    Promedio_normalizado = mean(promedios_regional_normalizado$Promedio_normalizado, na.rm = TRUE),
    Sd = sd(promedios_regional_normalizado$Promedio_normalizado, na.rm = TRUE),
    Num_ciudades = numciudades
  )
  # Agregar fila al dataframe de resultado
  df <- bind_rows(df, r)
}
```

```{r, echo = FALSE}
ggplot(df, aes(x = Producto, y = Num_ciudades )) +
  geom_bar(stat = "identity", fill = "skyblue", width = 0.7) +
  labs(
    title = "Numero de ciudades promedio que tienen un producto",
    x = "Producto",
    y = "Numero de ciudades"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Filtrando los productos que aparezcan en promedio al menos en 10 ciudades, **buscamos los cinco productos con menor y mayor desviacion est√°ndar.**
```{r}
df <- filter(df, Num_ciudades > 10 )
# Obtenemos n los datos que menos y mas varian
n = 5
menor_sd <- (arrange(df,Sd))
mayor_sd <- (arrange(df,desc(Sd)))

ggplot(df, aes(x = Producto, y = Sd )) +
  geom_bar(stat = "identity", fill = "skyblue", width = 0.7) +
  labs(
    title = "Desviaci√≥n estandar del precio a lo largo del tiempo",
    x = "Producto",
    y = "Desviaci√≥n estandar"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


kable(head(menor_sd, 5), format = "markdown",  caption = "Productos con menor desviaci√≥n est√°ndar")
selectos_min <- filter(datos_agro, Producto %in%  menor_sd[0:n,]$Producto)


kable(head(mayor_sd,5), format = "markdown", caption = "Productos con mayor desviaci√≥n est√°ndar")
selectos_max <- filter(datos_agro, Producto %in%  mayor_sd[0:n,]$Producto)


# Grafica la variacion del precio a lo largo del tiempo
plot_min <- graficar_tiempo_producto(selectos_min, "Menor desviacion")
plot_mas <- graficar_tiempo_producto(selectos_max, "Mayor desviacion")

# para graficar en una sola figura
print(plot_min)
print(plot_mas)
```

Ahora graficando los comportamientos anuales de cada producto

### Productos con menor variabilidad
```{r}
# Graficar por cada producto
for(i in unique(selectos_min$Producto)) {
  plot1 <- producto_comportamiento_tiempo(i)
  print(plot1)
}

```

### Productos con mayor variabilidad
```{r}
# Graficar por cada producto
for(i in unique(selectos_max$Producto)) {
  plot1 <- producto_comportamiento_tiempo(i)
  print(plot1)
}

```

## üñáÔ∏è‚Äã**Correlaci√≥n con fertilizantes**






